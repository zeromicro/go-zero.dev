<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.14">
<link rel="alternate" type="application/rss+xml" href="/go-zero.dev/en/blog/rss.xml" title="go-zero RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/go-zero.dev/en/blog/atom.xml" title="go-zero Atom Feed">
<link rel="search" type="application/opensearchdescription+xml" title="go-zero" href="/go-zero.dev/en/opensearch.xml"><title data-react-helmet="true">Go Queue | go-zero</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://zeromicro.github.io/go-zero.dev/en/docs/other-component/go-queue"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:version" content="current"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Go Queue | go-zero"><meta data-react-helmet="true" name="description" content="Delayed queue: a message queue with a delay function"><meta data-react-helmet="true" property="og:description" content="Delayed queue: a message queue with a delay function"><link data-react-helmet="true" rel="icon" href="/go-zero.dev/en/img/go-zero.svg"><link data-react-helmet="true" rel="canonical" href="https://zeromicro.github.io/go-zero.dev/en/docs/other-component/go-queue"><link data-react-helmet="true" rel="alternate" href="https://zeromicro.github.io/go-zero.dev/docs/other-component/go-queue" hreflang="zh"><link data-react-helmet="true" rel="alternate" href="https://zeromicro.github.io/go-zero.dev/en/docs/other-component/go-queue" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://zeromicro.github.io/go-zero.dev/docs/other-component/go-queue" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/go-zero.dev/en/assets/css/styles.0b454624.css">
<link rel="preload" href="/go-zero.dev/en/assets/js/runtime~main.7d0909b4.js" as="script">
<link rel="preload" href="/go-zero.dev/en/assets/js/main.4d4105f9.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/go-zero.dev/en/"><div class="navbar__logo"><img src="/go-zero.dev/en/img/go-zero.png" alt="Go-zero Logo" class="themedImage_TMUO themedImage--light_4Vu1"><img src="/go-zero.dev/en/img/go-zero.png" alt="Go-zero Logo" class="themedImage_TMUO themedImage--dark_uzRr"></div><b class="navbar__title">Go-zero</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/go-zero.dev/en/docs/intro/brief">Docs</a><a class="navbar__item navbar__link" href="/go-zero.dev/en/blog">Blog</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__link"><span><svg viewBox="0 0 20 20" width="20" height="20" aria-hidden="true" class="iconLanguage_EbrZ"><path fill="currentColor" d="M19.753 10.909c-.624-1.707-2.366-2.726-4.661-2.726-.09 0-.176.002-.262.006l-.016-2.063 3.525-.607c.115-.019.133-.119.109-.231-.023-.111-.167-.883-.188-.976-.027-.131-.102-.127-.207-.109-.104.018-3.25.461-3.25.461l-.013-2.078c-.001-.125-.069-.158-.194-.156l-1.025.016c-.105.002-.164.049-.162.148l.033 2.307s-3.061.527-3.144.543c-.084.014-.17.053-.151.143.019.09.19 1.094.208 1.172.018.08.072.129.188.107l2.924-.504.035 2.018c-1.077.281-1.801.824-2.256 1.303-.768.807-1.207 1.887-1.207 2.963 0 1.586.971 2.529 2.328 2.695 3.162.387 5.119-3.06 5.769-4.715 1.097 1.506.256 4.354-2.094 5.98-.043.029-.098.129-.033.207l.619.756c.08.096.206.059.256.023 2.51-1.73 3.661-4.515 2.869-6.683zm-7.386 3.188c-.966-.121-.944-.914-.944-1.453 0-.773.327-1.58.876-2.156a3.21 3.21 0 011.229-.799l.082 4.277a2.773 2.773 0 01-1.243.131zm2.427-.553l.046-4.109c.084-.004.166-.01.252-.01.773 0 1.494.145 1.885.361.391.217-1.023 2.713-2.183 3.758zm-8.95-7.668a.196.196 0 00-.196-.145h-1.95a.194.194 0 00-.194.144L.008 16.916c-.017.051-.011.076.062.076h1.733c.075 0 .099-.023.114-.072l1.008-3.318h3.496l1.008 3.318c.016.049.039.072.113.072h1.734c.072 0 .078-.025.062-.076-.014-.05-3.083-9.741-3.494-11.04zm-2.618 6.318l1.447-5.25 1.447 5.25H3.226z"></path></svg><span>English</span></span></a><ul class="dropdown__menu"><li><a href="/go-zero.dev/docs/other-component/go-queue" target="_self" rel="noopener noreferrer" class="dropdown__link">ä¸­æ–‡</a></li><li><a href="/go-zero.dev/en/docs/other-component/go-queue" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active">English</a></li></ul></div><a href="https://github.com/zeromicro/go-zero" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_iYfV toggle_2i4l toggleDisabled_xj38"><div class="toggleTrack_t-f2" role="button" tabindex="-1"><div class="toggleTrackCheck_mk7D"><span class="toggleIcon_pHJ9">ðŸŒœ</span></div><div class="toggleTrackX_dm8H"><span class="toggleIcon_pHJ9">ðŸŒž</span></div><div class="toggleTrackThumb_W6To"></div></div><input type="checkbox" class="toggleScreenReader_h9qa" aria-label="Switch between dark and light mode"></div><div class="searchBox_Utm0"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_lDyR"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_i9tI" type="button"></button><aside class="docSidebarContainer_0YBq"><div class="sidebar_a3j0"><nav class="menu thin-scrollbar menu_cyFh"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/go-zero.dev/en/docs/intro/brief">Introduction</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/go-zero.dev/en/docs/quick-start/concept">Quick Start</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/go-zero.dev/en/docs/build-tool/tool-intro">Build Tool</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/go-zero.dev/en/docs/component/rest">Components</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active hasHref_TwRn" href="/go-zero.dev/en/docs/other-component/go-queue">Other Components</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/go-zero.dev/en/docs/other-component/go-queue">Go Queue</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/go-zero.dev/en/docs/other-component/mapreduce">MapReduce</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/go-zero.dev/en/docs/problem/in-use">Problems</a></div></li></ul></nav></div></aside><main class="docMainContainer_r8cw"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_zHA2"><div class="docItemContainer_oiyr"><article><div class="tocCollapsible_aw-L theme-doc-toc-mobile tocMobile_Tx6Y"><button type="button" class="clean-btn tocCollapsibleButton_zr6a">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Go Queue</h1></header><p>Delayed queue: a message queue with a delay function</p><ul><li>deferred â†’ an indefinite time in the future</li><li>mq â†’ consumption behavior is sequential</li></ul><p>With this explanation, the whole design is clear. Your purpose is delay, and the bearer container is mq.</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="background">Background<a class="hash-link" href="#background" title="Direct link to heading">â€‹</a></h3><p>To list scenarios that may exist in my daily business.</p><ul><li>Creating a delayed schedule and needing to remind the teacher of class</li><li>Delayed push â†’ pushing the teacher needs announcements and assignments</li></ul><p>To solve the above problem, the easiest and most direct way is to go to the schedule sweeper regularly.</p><div class="admonition admonition-info alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</h5></div><div class="admonition-content"><p>When the service starts, open an asynchronous concurrent process â†’ scan the msg table at regular intervals, trigger an event when it arrives, and call the corresponding handler</p></div></div><p>Several disadvantages.</p><ul><li>Every service that needs a timed/delayed task needs a msg table for additional storage â†’ storage is coupled with the business</li><li>Timed scanning â†’ bad timing control, may miss trigger time</li><li>It is a burden on the msg table instance. Repeatedly, one service keeps putting constant pressure on the database</li></ul><p>What is the biggest problem?</p><p>Scheduling model is basically unified, don&#x27;t do duplicate business logic</p><p>We can consider taking the logic out of the specific business logic and turning it into a common part.</p><p>And this scheduling model, is the delay queue .</p><p>In fact, to put it plainly.</p><p>The delayed queue model is to store future execution events in advance, and then continuously scan this store to execute the corresponding task logic if the execution time is triggered.</p><p>So is there a ready-made solution in the open source world? The answer is yes. Beanstalk (<a href="https://github.com/beanstalkd/beanstalkd" target="_blank" rel="noopener noreferrer">https://github.com/beanstalkd/beanstalkd</a>) basically meets these requirements</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="design-purpose">Design purpose<a class="hash-link" href="#design-purpose" title="Direct link to heading">â€‹</a></h3><ul><li>Consumer behavior at least</li><li>High availability</li><li>Real-time</li><li>Support for message deletion</li></ul><p>The design directions for these purposes are stated one at a time.</p><h4 class="anchor anchorWithStickyNavbar_y2LR" id="consumption-behavior">consumption behavior<a class="hash-link" href="#consumption-behavior" title="Direct link to heading">â€‹</a></h4><p>This concept is taken from mq. mq provides several directions for consuming casts.</p><ul><li>at most once â†’ at most once, messages may be lost, but not repeated</li><li>at least once â†’ at least once, the message is definitely not lost, but may be repeated</li><li>exactly once â†’ once and only once, messages are not lost and not repeated, and are consumed only once.</li></ul><p>exactly once is guaranteed on both the producer + consumer side if possible. When the producer has no way to guarantee this, the consumer needs to do a de-duplication before consumption, so that the message is consumed once and not repeatedly, which is guaranteed directly inside the delay queue.</p><p>The simplest: use redis setNX to achieve unique consumption of job ids</p><h4 class="anchor anchorWithStickyNavbar_y2LR" id="high-availability">High Availability<a class="hash-link" href="#high-availability" title="Direct link to heading">â€‹</a></h4><p>Multi-instance deployment is supported. When one instance goes down, there is a backup instance that continues to provide services.</p><p>This externally available API uses a cluster model, where multiple nodes are encapsulated internally and redundant storage is available across multiple nodes.</p><h4 class="anchor anchorWithStickyNavbar_y2LR" id="why-not-use-kafka">Why not use Kafka?<a class="hash-link" href="#why-not-use-kafka" title="Direct link to heading">â€‹</a></h4><p>After considering similar solutions based on message queues such as kafka/rocketmq as storage, the storage design model abandoned this option.</p><p>For example, suppose we use a message queue storage like Kafka to implement the delay function, each queue time needs to create a separate topic (e.g. Q1-1s, Q1-2s...) . This design is not a big problem in scenarios where the delay time is fixed, but if the delay time varies greatly, the number of topics will be too many, which will turn the disk from sequential reads and writes into random reads and writes, leading to performance degradation and other problems like restart or long recovery time.</p><ul><li>Too many topics â†’ storage pressure</li><li>The topic stores the real time, and the reads at different times (topic) are sequential reads â†’ random reads when scheduling.</li><li>Similarly, when writing, sequential write â†’ random write</li></ul><h3 class="anchor anchorWithStickyNavbar_y2LR" id="architecture-design">Architecture Design<a class="hash-link" href="#architecture-design" title="Direct link to heading">â€‹</a></h3><p><img alt="dq" src="/go-zero.dev/en/assets/images/dq-331b7d0b1bbf68ce738abc2b98494908.png"></p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="api-design">API Design<a class="hash-link" href="#api-design" title="Direct link to heading">â€‹</a></h3><p>producer</p><ul><li>producer.At(msg []byte, at time.Time)</li><li>producer.Delay(body []byte, delay time.Duration)</li><li>producer.Revoke(ids string)</li></ul><p>consumer</p><ul><li>consumer.Consume(consume handler)</li></ul><p>After using the delayed queue, the overall structure of the service is as follows, as well as the state changes of the jobs in the queue.</p><p><img alt="delay queue" src="/go-zero.dev/en/assets/images/delay-queue-1c877cf86953a348b998680e772112c8.png"></p><ul><li>service â†’ producer.At(msg []byte, at time.Time) â†’ insert delayed job into the tube</li><li>Timed trigger â†’ job state is updated to ready</li><li>consumer gets ready job â†’ fetches job and starts consuming; and changes state to reserved</li><li>Execute the handler logic function passed into the consumer</li></ul><h3 class="anchor anchorWithStickyNavbar_y2LR" id="production-practice">Production Practice<a class="hash-link" href="#production-practice" title="Direct link to heading">â€‹</a></h3><p>It mainly describes what specific features we use for delayed queues in our daily development.</p><h4 class="anchor anchorWithStickyNavbar_y2LR" id="production-side">Production side<a class="hash-link" href="#production-side" title="Direct link to heading">â€‹</a></h4><ul><li>To produce a delayed task in development, just determine the task execution time<ul><li>Pass in At() producer.At(msg []byte, at time.Time)</li><li>The time difference is calculated internally by itself and inserted into tube</li></ul></li><li>If there are changes to the task time, and changes to the task content<ul><li>In production time, it may be necessary to create an additional relationship table of logic_id â†’ job_id</li><li>Query to job_id â†’ producer.Revoke(ids string), delete it, and reinsert it</li></ul></li></ul><h4 class="anchor anchorWithStickyNavbar_y2LR" id="consumer-side">consumer side<a class="hash-link" href="#consumer-side" title="Direct link to heading">â€‹</a></h4><p>First, the framework level to ensure that the consumption behavior of exactly once, but the upper business logic consumption failure or network problems, or a variety of problems, resulting in consumption failure, the bottom to the business development to do. Reasons for doing so.</p><ul><li>framework and the underlying components only to ensure the correctness of the flow of job state</li><li>Framework consumer side only to ensure the uniformity of consumption behavior</li><li>delayed tasks in different business behavior is not uniform<ul><li>Emphasis on the mandatory nature of the task, the consumption of failure requires continuous retry until the task success</li><li>Emphasis on the punctuality of the task, then consumption failure, business-insensitive, can choose to discard</li></ul></li></ul><p>Here is a description of how the consumer side of the framework to ensure the uniformity of consumption behavior.</p><p>There are cluster and node. cluster.</p><p><code>https://github.com/tal-tech/go-queue/blob/master/dq/consumer.go#L45</code></p><ul><li>The cluster internally repackages the consume handler with a layer</li><li>hash the consume body and use this hash as the key for redis de-duplication</li><li>If it exists, it is not processed and is discarded</li></ul><h4 class="anchor anchorWithStickyNavbar_y2LR" id="node">node<a class="hash-link" href="#node" title="Direct link to heading">â€‹</a></h4><p><code>https://github.com/tal-tech/go-queue/blob/master/dq/consumernode.go#L36</code></p><ul><li>consume node to get ready job; first execute Reserve(TTR), book this job, will execute this job for logical processing</li><li>delete(job) in the node; then consume<ul><li>If it fails, it will be thrown up to the business layer to do the corresponding under the hood retry</li></ul></li></ul><p>So for the consumption side, developers need to implement the idempotency of consumption themselves.</p><p><img alt="idempotent" src="/go-zero.dev/en/assets/images/idempotent-31ee2053de9ace0b83517201c6af3c51.png"></p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="usage-examples">Usage examples<a class="hash-link" href="#usage-examples" title="Direct link to heading">â€‹</a></h3><p><a href="https://github.com/zeromicro/go-queue/tree/master/example" target="_blank" rel="noopener noreferrer">usage example</a></p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/go-zero.dev/en/docs/component/metric"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Metric</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/go-zero.dev/en/docs/other-component/mapreduce"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">MapReduce</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_vrFS thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#background" class="table-of-contents__link toc-highlight">Background</a></li><li><a href="#design-purpose" class="table-of-contents__link toc-highlight">Design purpose</a></li><li><a href="#architecture-design" class="table-of-contents__link toc-highlight">Architecture Design</a></li><li><a href="#api-design" class="table-of-contents__link toc-highlight">API Design</a></li><li><a href="#production-practice" class="table-of-contents__link toc-highlight">Production Practice</a></li><li><a href="#usage-examples" class="table-of-contents__link toc-highlight">Usage examples</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/go-zero.dev/en/docs/intro/brief">docs</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://join.slack.com/t/go-zero/shared_invite/zt-10ruju779-BE4y6lQNB_R21samtyKTgA" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Chat Group<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/go-zero.dev/en/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/zeromicro/go-zero" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2022 go-zero.dev, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/go-zero.dev/en/assets/js/runtime~main.7d0909b4.js"></script>
<script src="/go-zero.dev/en/assets/js/main.4d4105f9.js"></script>
</body>
</html>