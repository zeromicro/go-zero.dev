<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.14">
<link rel="alternate" type="application/rss+xml" href="/go-zero.dev/en/blog/rss.xml" title="go-zero RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/go-zero.dev/en/blog/atom.xml" title="go-zero Atom Feed">
<link rel="search" type="application/opensearchdescription+xml" title="go-zero" href="/go-zero.dev/en/opensearch.xml"><title data-react-helmet="true">Load Balancer | go-zero</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://zeromicro.github.io/go-zero.dev/en/docs/component/balance"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:version" content="current"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Load Balancer | go-zero"><meta data-react-helmet="true" name="description" content="Background"><meta data-react-helmet="true" property="og:description" content="Background"><link data-react-helmet="true" rel="icon" href="/go-zero.dev/en/img/go-zero.svg"><link data-react-helmet="true" rel="canonical" href="https://zeromicro.github.io/go-zero.dev/en/docs/component/balance"><link data-react-helmet="true" rel="alternate" href="https://zeromicro.github.io/go-zero.dev/docs/component/balance" hreflang="zh"><link data-react-helmet="true" rel="alternate" href="https://zeromicro.github.io/go-zero.dev/en/docs/component/balance" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://zeromicro.github.io/go-zero.dev/docs/component/balance" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/go-zero.dev/en/assets/css/styles.0b454624.css">
<link rel="preload" href="/go-zero.dev/en/assets/js/runtime~main.998bd6c3.js" as="script">
<link rel="preload" href="/go-zero.dev/en/assets/js/main.4d4105f9.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/go-zero.dev/en/"><div class="navbar__logo"><img src="/go-zero.dev/en/img/go-zero.png" alt="Go-zero Logo" class="themedImage_TMUO themedImage--light_4Vu1"><img src="/go-zero.dev/en/img/go-zero.png" alt="Go-zero Logo" class="themedImage_TMUO themedImage--dark_uzRr"></div><b class="navbar__title">Go-zero</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/go-zero.dev/en/docs/intro/brief">Docs</a><a class="navbar__item navbar__link" href="/go-zero.dev/en/blog">Blog</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__link"><span><svg viewBox="0 0 20 20" width="20" height="20" aria-hidden="true" class="iconLanguage_EbrZ"><path fill="currentColor" d="M19.753 10.909c-.624-1.707-2.366-2.726-4.661-2.726-.09 0-.176.002-.262.006l-.016-2.063 3.525-.607c.115-.019.133-.119.109-.231-.023-.111-.167-.883-.188-.976-.027-.131-.102-.127-.207-.109-.104.018-3.25.461-3.25.461l-.013-2.078c-.001-.125-.069-.158-.194-.156l-1.025.016c-.105.002-.164.049-.162.148l.033 2.307s-3.061.527-3.144.543c-.084.014-.17.053-.151.143.019.09.19 1.094.208 1.172.018.08.072.129.188.107l2.924-.504.035 2.018c-1.077.281-1.801.824-2.256 1.303-.768.807-1.207 1.887-1.207 2.963 0 1.586.971 2.529 2.328 2.695 3.162.387 5.119-3.06 5.769-4.715 1.097 1.506.256 4.354-2.094 5.98-.043.029-.098.129-.033.207l.619.756c.08.096.206.059.256.023 2.51-1.73 3.661-4.515 2.869-6.683zm-7.386 3.188c-.966-.121-.944-.914-.944-1.453 0-.773.327-1.58.876-2.156a3.21 3.21 0 011.229-.799l.082 4.277a2.773 2.773 0 01-1.243.131zm2.427-.553l.046-4.109c.084-.004.166-.01.252-.01.773 0 1.494.145 1.885.361.391.217-1.023 2.713-2.183 3.758zm-8.95-7.668a.196.196 0 00-.196-.145h-1.95a.194.194 0 00-.194.144L.008 16.916c-.017.051-.011.076.062.076h1.733c.075 0 .099-.023.114-.072l1.008-3.318h3.496l1.008 3.318c.016.049.039.072.113.072h1.734c.072 0 .078-.025.062-.076-.014-.05-3.083-9.741-3.494-11.04zm-2.618 6.318l1.447-5.25 1.447 5.25H3.226z"></path></svg><span>English</span></span></a><ul class="dropdown__menu"><li><a href="/go-zero.dev/docs/component/balance" target="_self" rel="noopener noreferrer" class="dropdown__link">ä¸­æ–‡</a></li><li><a href="/go-zero.dev/en/docs/component/balance" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active">English</a></li></ul></div><a href="https://github.com/zeromicro/go-zero" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_iYfV toggle_2i4l toggleDisabled_xj38"><div class="toggleTrack_t-f2" role="button" tabindex="-1"><div class="toggleTrackCheck_mk7D"><span class="toggleIcon_pHJ9">ðŸŒœ</span></div><div class="toggleTrackX_dm8H"><span class="toggleIcon_pHJ9">ðŸŒž</span></div><div class="toggleTrackThumb_W6To"></div></div><input type="checkbox" class="toggleScreenReader_h9qa" aria-label="Switch between dark and light mode"></div><div class="searchBox_Utm0"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_lDyR"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_i9tI" type="button"></button><aside class="docSidebarContainer_0YBq"><div class="sidebar_a3j0"><nav class="menu thin-scrollbar menu_cyFh"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/go-zero.dev/en/docs/intro/brief">Introduction</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/go-zero.dev/en/docs/quick-start/concept">Quick Start</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/go-zero.dev/en/docs/build-tool/tool-intro">Build Tool</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active hasHref_TwRn" href="/go-zero.dev/en/docs/component/rest">Components</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/go-zero.dev/en/docs/component/rest">rest</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/go-zero.dev/en/docs/component/cache">Cache</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/go-zero.dev/en/docs/component/breaker">Circuit Breaker</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/go-zero.dev/en/docs/component/load">Overload Protection</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/go-zero.dev/en/docs/component/balance">Load Balancer</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/go-zero.dev/en/docs/component/discovery">Discovery</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/go-zero.dev/en/docs/component/trace">Tracing</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/go-zero.dev/en/docs/component/metric">Metric</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/go-zero.dev/en/docs/other-component/go-queue">Other Components</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/go-zero.dev/en/docs/problem/in-use">Problems</a></div></li></ul></nav></div></aside><main class="docMainContainer_r8cw"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_zHA2"><div class="docItemContainer_oiyr"><article><div class="tocCollapsible_aw-L theme-doc-toc-mobile tocMobile_Tx6Y"><button type="button" class="clean-btn tocCollapsibleButton_zr6a">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Load Balancer</h1></header><h3 class="anchor anchorWithStickyNavbar_y2LR" id="background">Background<a class="hash-link" href="#background" title="Direct link to heading">â€‹</a></h3><p>When selecting a load balancing algorithm, we want to meet the following requirements.</p><ul><li>Have partitioning and server room scheduling affinity<ul><li>Choose the node with the lowest load possible each time</li><li>Select the fastest responsive node possible each time</li></ul></li><li>No need for manual intervention on failed nodes<ul><li>When a node fails, the load balancing algorithm can automatically isolate the node</li><li>When a failed node recovers, traffic distribution to that node can be automatically resumed</li></ul></li></ul><p>Translated with <a href="http://www.DeepL.com/Translator" target="_blank" rel="noopener noreferrer">www.DeepL.com/Translator</a> (free version)</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="the-core-idea-of-the-algorithm">The core idea of the algorithm<a class="hash-link" href="#the-core-idea-of-the-algorithm" title="Direct link to heading">â€‹</a></h3><h4 class="anchor anchorWithStickyNavbar_y2LR" id="p2c">p2c<a class="hash-link" href="#p2c" title="Direct link to heading">â€‹</a></h4><p><code>p2c</code> (Pick Of 2 Choices) Choose one of two: Randomly select two nodes among multiple nodes.</p><p><code>go-zero</code> in will be randomly selected 3 times, and if the health condition of one of the selected nodes meets the requirement, the selection is interrupted and both nodes are adopted.</p><h4 class="anchor anchorWithStickyNavbar_y2LR" id="ewma">EWMA<a class="hash-link" href="#ewma" title="Direct link to heading">â€‹</a></h4><p><code>EWMA</code> (Exponentially Weighted Moving-Average) Exponential Moving Weighted Average: The weighting factor of each value decreases exponentially over time, and the closer the value is to the current moment, the larger the weighting factor is, reflecting the average value over the most recent period.</p><ul><li>Formulaï¼š</li></ul><p><img alt="ewma" src="/go-zero.dev/en/assets/images/ewma-e7d58d4396f07ed4b07dae5f88b6912f.png"></p><ul><li>Variable Explanationï¼š<ul><li>Vt: represents the EWMA value of the tth request</li><li>Vt-1: represents the EWMA value of the t-1st request</li><li>Î²: is a constant</li></ul></li></ul><h4 class="anchor anchorWithStickyNavbar_y2LR" id="ewma-advantages-of-the-algorithm">EWMA Advantages of the algorithm<a class="hash-link" href="#ewma-advantages-of-the-algorithm" title="Direct link to heading">â€‹</a></h4><ul><li><p>Compared to the common algorithm for calculating average values, EWMA does not need to save all the past values, which significantly reduces the amount of computation and storage resources.</p></li><li><p>The traditional algorithm for calculating the average is not sensitive to the network time consumption, while EWMA can adjust Î² by the frequency of requests to quickly monitor the network burr or more reflect the overall average.</p><ul><li>When the requests are more frequent, it means that the node network load is increasing, and we want to monitor the node processing time (which reflects the node load), we adjust Î² down accordingly. Î² is smaller, the EWMA value is closer to this time, and then we can quickly monitor the network burr;</li><li>When the requests are less frequent, we adjust the Î² value relatively larger. In this way, the calculated EWMA value is closer to the average value.</li></ul></li></ul><h4 class="anchor anchorWithStickyNavbar_y2LR" id="Î²-calculation">Î² calculation<a class="hash-link" href="#Î²-calculation" title="Direct link to heading">â€‹</a></h4><p>The <code>go-zero</code> uses the decay function model from Newton&#x27;s cooling law to calculate the <code>Î²</code> value in the <code>EWMA</code> algorithm:</p><p><img alt="ewma" src="/go-zero.dev/en/assets/images/Î²-c79d184dbc37ca4b6e6c69132a3fcf5f.png"></p><p>where <code>Î”t</code> is the interval between two requests, <code>e</code>, <code>k</code> are constants</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="implementing-a-custom-load-balancer-in-grpc">Implementing a custom load balancer in gRPC<a class="hash-link" href="#implementing-a-custom-load-balancer-in-grpc" title="Direct link to heading">â€‹</a></h3><p>First we need to implement google.golang.org/grpc/balancer/base/base.go/PickerBuilder interface, this interface is when there is a service node update will call the interface&#x27;s Build method</p><div class="codeBlockContainer_J+bg language-go theme-code-block"><div style="color:#393A34;background-color:#f6f8fa" class="codeBlockTitle_oQzk">grpc-go/balancer/base/base.go</div><div class="codeBlockContent_csEI go"><pre tabindex="0" class="prism-code language-go codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> PickerBuilder </span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Build returns a picker that will be used by gRPC to pick a SubConn.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">Build</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">info PickerBuildInfo</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> balancer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Picker</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>It also implements the google.golang.org/grpc/balancer/balancer.go/Picker interface. This interface mainly implements load balancing, picking a node for requests</p><div class="codeBlockContainer_J+bg language-go theme-code-block"><div style="color:#393A34;background-color:#f6f8fa" class="codeBlockTitle_oQzk">grpc-go/balancer/balancer.go</div><div class="codeBlockContent_csEI go"><pre tabindex="0" class="prism-code language-go codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> Picker </span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">Pick</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">info PickInfo</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">PickResult</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Finally, register our implemented load balancer with the load balancing map</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="the-main-logic-of-go-zeros-load-balancing-implementation">The main logic of go-zero&#x27;s load balancing implementation<a class="hash-link" href="#the-main-logic-of-go-zeros-load-balancing-implementation" title="Direct link to heading">â€‹</a></h3><ul><li><p>At each node update, <code>gRPC</code> will call the <code>Build</code> method, where all the node information is stored in <code>Build</code>.</p></li><li><p><code>gRPC</code> calls the <code>Pick</code> method to fetch nodes when it fetches nodes to process requests. <code>go-zero</code> implements the <code>p2c</code> algorithm in the <code>Pick</code> method to pick the node and calculate the load from the <code>EWMA</code> value of the node and return the node with low load for gRPC to use.</p></li><li><p>At the end of the request <code>gRPC</code> calls the <code>PickResult.Done</code> method, in which <code>go-zero</code> stores the information about the time spent on this request and calculates the <code>EWMA</code> value and saves it for the next request to calculate the load and so on.</p></li></ul><h3 class="anchor anchorWithStickyNavbar_y2LR" id="load-balancing-code-analysis">Load Balancing Code Analysis<a class="hash-link" href="#load-balancing-code-analysis" title="Direct link to heading">â€‹</a></h3><h4 class="anchor anchorWithStickyNavbar_y2LR" id="save-all-node-information-of-the-service">Save all node information of the service<a class="hash-link" href="#save-all-node-information-of-the-service" title="Direct link to heading">â€‹</a></h4><p>We need to keep information about the time taken by the node to process this request, <code>EWMA</code>, etc. <code>go-zero</code> has designed the following structure for each node.</p><div class="codeBlockContainer_J+bg language-go theme-code-block"><div style="color:#393A34;background-color:#f6f8fa" class="codeBlockTitle_oQzk">go-zero/zrpc/internal/balancer/p2c/p2c.go</div><div class="codeBlockContent_csEI go"><pre tabindex="0" class="prism-code language-go codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> subConn </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    addr     resolver</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Address</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    conn     balancer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">SubConn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    lag      </span><span class="token builtin">uint64</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// Used to save ewma values</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    inflight </span><span class="token builtin">int64</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Used to keep the total number of requests being processed by the current node</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    success  </span><span class="token builtin">uint64</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// Used to identify the health status of this connection over time</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    requests </span><span class="token builtin">int64</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Used to store the total number of requests</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    last     </span><span class="token builtin">int64</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Used to save the last request time, used to calculate the ewma value</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pick     </span><span class="token builtin">int64</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Save the last selected point in time</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4 class="anchor anchorWithStickyNavbar_y2LR" id="p2cpicker-implements-the-balancerpicker-interface-and-conns-holds-information-about-all-nodes-of-the-service"><code>p2cPicker</code> implements the <code>balancer.Picker</code> interface, and <code>conns</code> holds information about all nodes of the service<a class="hash-link" href="#p2cpicker-implements-the-balancerpicker-interface-and-conns-holds-information-about-all-nodes-of-the-service" title="Direct link to heading">â€‹</a></h4><div class="codeBlockContainer_J+bg language-go theme-code-block"><div style="color:#393A34;background-color:#f6f8fa" class="codeBlockTitle_oQzk">go-zero/zrpc/internal/balancer/p2c/p2c.go</div><div class="codeBlockContent_csEI go"><pre tabindex="0" class="prism-code language-go codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> p2cPicker </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  conns </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">subConn  </span><span class="token comment" style="color:#999988;font-style:italic">// Save information about all nodes </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  r     </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">rand</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Rand</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  stamp </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">syncx</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AtomicDuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  lock  sync</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Mutex</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4 class="anchor anchorWithStickyNavbar_y2LR" id="grpc-calls-the-build-method-when-a-node-is-updated-passing-in-all-the-node-information-where-we-save-each-node-information-in-a-subconn-structure-here-we-save-each-node-information-in-a-subconn-structure-and-merge-them-together-in-a-p2cpicker-structure"><code>gRPC</code> calls the <code>Build</code> method when a node is updated, passing in all the node information, where we save each node information in a subConn structure. Here we save each node information in a subConn structure and merge them together in a <code>p2cPicker</code> structure<a class="hash-link" href="#grpc-calls-the-build-method-when-a-node-is-updated-passing-in-all-the-node-information-where-we-save-each-node-information-in-a-subconn-structure-here-we-save-each-node-information-in-a-subconn-structure-and-merge-them-together-in-a-p2cpicker-structure" title="Direct link to heading">â€‹</a></h4><div class="codeBlockContainer_J+bg language-go theme-code-block"><div style="color:#393A34;background-color:#f6f8fa" class="codeBlockTitle_oQzk">go-zero/zrpc/internal/balancer/p2c/p2c.go:42</div><div class="codeBlockContent_csEI go"><pre tabindex="0" class="prism-code language-go codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">b </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">p2cPickerBuilder</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Build</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">info base</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">PickerBuildInfo</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> balancer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Picker </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">...</span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> conns </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">subConn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> conn</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> connInfo </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">range</span><span class="token plain"> readySCs </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    conns </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">conns</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">subConn</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      addr</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">    connInfo</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Address</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      conn</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">    conn</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      success</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> initSuccess</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">p2cPicker</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    conns</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> conns</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    r</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">     rand</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">New</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rand</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewSource</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Now</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">UnixNano</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    stamp</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> syncx</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewAtomicDuration</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4 class="anchor anchorWithStickyNavbar_y2LR" id="randomly-selected-node-information-is-divided-into-three-cases-here">Randomly selected node information is divided into three cases here:<a class="hash-link" href="#randomly-selected-node-information-is-divided-into-three-cases-here" title="Direct link to heading">â€‹</a></h4><p>The main implementation code is as follows.</p><div class="codeBlockContainer_J+bg language-go theme-code-block"><div style="color:#393A34;background-color:#f6f8fa" class="codeBlockTitle_oQzk">go-zero/zrpc/internal/balancer/p2c/p2c.go:80</div><div class="codeBlockContent_csEI go"><pre tabindex="0" class="prism-code language-go codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">switch</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">conns</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// No node, return error</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> emptyPickResult</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> balancer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ErrNoSubConnAvailable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// There is a node, return this node directly</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    chosen </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">choose</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">conns</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// There are two nodes, calculate the load and return the node with the lower load</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    chosen </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">choose</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">conns</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">conns</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">default</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// There are multiple nodes, p2c picks two nodes, compares the load of these two nodes, and returns the node with the lower load</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> node1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> node2 </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">subConn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 3 times random selection of two nodes</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> pickTimes</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      a </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">r</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Intn</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">conns</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      b </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">r</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Intn</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">conns</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> b </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> a </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        b</span><span class="token operator" style="color:#393A34">++</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      node1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">conns</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">a</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      node2 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">conns</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">b</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">// If the selected node meets the health requirements this time, break the selection</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> node1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">healthy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> node2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">healthy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">break</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Compare the load of the two nodes and choose the one with the lower load</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    chosen </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">choose</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">node1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> node2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li><p>There is only one service node, which is returned directly for gRPC use</p></li><li><p>There are two service nodes, calculate the load by EWMA value, and return the node with low load for gRPC</p></li><li><p>With multiple service nodes, two nodes are selected by the p2c algorithm, the load is compared, and the node with the lower load is returned for gRPC</p></li></ul><h4 class="anchor anchorWithStickyNavbar_y2LR" id="load-calculates-the-load-of-the-node"><code>load</code> calculates the load of the node<a class="hash-link" href="#load-calculates-the-load-of-the-node" title="Direct link to heading">â€‹</a></h4><p>The <code>choose</code> method above will call the <code>load</code> method to calculate the node load.</p><p>The formula for calculating the load is: <code>load = ewma * inflight</code></p><p>Here is a brief explanation: <code>ewma</code> is the average request time, <code>inflight</code> is the number of requests being processed by the current node, and multiplying them together roughly calculates the network load of the current node.</p><div class="codeBlockContainer_J+bg language-go theme-code-block"><div class="codeBlockContent_csEI go"><pre tabindex="0" class="prism-code language-go codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">subConn</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">load</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">int64</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Calculate the load of the node by EWMA; add 1 to avoid the case of 0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  lag </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">int64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">math</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Sqrt</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">float64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">atomic</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">LoadUint64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lag</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  load </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> lag </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">atomic</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">LoadInt64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">inflight</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> load </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> penalty</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> load</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4 class="anchor anchorWithStickyNavbar_y2LR" id="end-of-request-update-information-such-as-ewma-of-the-node">End of request, update information such as <code>EWMA</code> of the node<a class="hash-link" href="#end-of-request-update-information-such-as-ewma-of-the-node" title="Direct link to heading">â€‹</a></h4><div class="codeBlockContainer_J+bg language-go theme-code-block"><div class="codeBlockContent_csEI go"><pre tabindex="0" class="prism-code language-go codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">p </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">p2cPicker</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">buildDoneFunc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">subConn</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">info balancer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DoneInfo</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  start </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">int64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">timex</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Now</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">info balancer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DoneInfo</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Number of requests being processed minus 1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    atomic</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">AddInt64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">inflight</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    now </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> timex</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Now</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Save the time point at the end of this request and retrieve the time point at the last request</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    last </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> atomic</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SwapInt64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">last</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">int64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">now</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    td </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">int64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">now</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> last</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> td </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      td </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Calculation of Î² in EWMA algorithm using the decay function model in Newton&#x27;s cooling law</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    w </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> math</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Exp</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">float64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">td</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">float64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">decayTime</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Save the elapsed time of this request</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    lag </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">int64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">now</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> start</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> lag </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      lag </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    olag </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> atomic</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">LoadUint64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lag</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> olag </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      w </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Calculating EWMA values</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    atomic</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">StoreUint64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lag</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">uint64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">float64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">olag</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">w</span><span class="token operator" style="color:#393A34">+</span><span class="token function" style="color:#d73a49">float64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">lag</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">w</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    success </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> initSuccess</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> info</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token plain">codes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Acceptable</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">info</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      success </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    osucc </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> atomic</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">LoadUint64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">success</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    atomic</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">StoreUint64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">success</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">uint64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">float64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">osucc</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">w</span><span class="token operator" style="color:#393A34">+</span><span class="token function" style="color:#d73a49">float64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">success</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">w</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    stamp </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">stamp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Load</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> now</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">stamp </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> logInterval </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">stamp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">CompareAndSwap</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">stamp</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> now</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">logStats</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>Subtract 1 from the total number of requests being processed by the node</li><li>Save the time point at which the processing of the request ended, which is used to calculate the difference between the last request processed by the node and to calculate the Î² value in the EWMA</li><li>calculate the time taken for this request and calculate the EWMA value and save it to the lag attribute of the node</li><li>Calculates the health status of the node and stores it in the success attribute of the node</li></ul></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/go-zero.dev/en/docs/component/load"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Overload Protection</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/go-zero.dev/en/docs/component/discovery"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Discovery</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_vrFS thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#background" class="table-of-contents__link toc-highlight">Background</a></li><li><a href="#the-core-idea-of-the-algorithm" class="table-of-contents__link toc-highlight">The core idea of the algorithm</a></li><li><a href="#implementing-a-custom-load-balancer-in-grpc" class="table-of-contents__link toc-highlight">Implementing a custom load balancer in gRPC</a></li><li><a href="#the-main-logic-of-go-zeros-load-balancing-implementation" class="table-of-contents__link toc-highlight">The main logic of go-zero&#39;s load balancing implementation</a></li><li><a href="#load-balancing-code-analysis" class="table-of-contents__link toc-highlight">Load Balancing Code Analysis</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/go-zero.dev/en/docs/intro/brief">docs</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://join.slack.com/t/go-zero/shared_invite/zt-10ruju779-BE4y6lQNB_R21samtyKTgA" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Chat Group<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/go-zero.dev/en/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/zeromicro/go-zero" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2022 go-zero.dev, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/go-zero.dev/en/assets/js/runtime~main.998bd6c3.js"></script>
<script src="/go-zero.dev/en/assets/js/main.4d4105f9.js"></script>
</body>
</html>