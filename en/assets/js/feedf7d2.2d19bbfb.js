"use strict";(self.webpackChunktmp=self.webpackChunktmp||[]).push([[8912],{3905:function(e,t,n){n.d(t,{Zo:function(){return d},kt:function(){return m}});var a=n(7294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function r(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var l=a.createContext({}),u=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):r(r({},t),e)),n},d=function(e){var t=u(e.components);return a.createElement(l.Provider,{value:t},e.children)},c={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},p=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,o=e.originalType,l=e.parentName,d=s(e,["components","mdxType","originalType","parentName"]),p=u(n),m=i,h=p["".concat(l,".").concat(m)]||p[m]||c[m]||o;return n?a.createElement(h,r(r({ref:t},d),{},{components:n})):a.createElement(h,r({ref:t},d))}));function m(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var o=n.length,r=new Array(o);r[0]=p;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:i,r[1]=s;for(var u=2;u<o;u++)r[u]=n[u];return a.createElement.apply(null,r)}return a.createElement.apply(null,n)}p.displayName="MDXCreateElement"},432:function(e,t,n){n.r(t),n.d(t,{frontMatter:function(){return s},contentTitle:function(){return l},metadata:function(){return u},toc:function(){return d},default:function(){return p}});var a=n(7462),i=n(3366),o=(n(7294),n(3905)),r=["components"],s={sidebar_position:1},l="Go Queue",u={unversionedId:"other-component/go-queue",id:"other-component/go-queue",title:"Go Queue",description:"Delayed queue: a message queue with a delay function",source:"@site/i18n/en/docusaurus-plugin-content-docs/current/other-component/go-queue.md",sourceDirName:"other-component",slug:"/other-component/go-queue",permalink:"/go-zero.dev/en/docs/other-component/go-queue",tags:[],version:"current",sidebarPosition:1,frontMatter:{sidebar_position:1},sidebar:"tutorialSidebar",previous:{title:"Metric",permalink:"/go-zero.dev/en/docs/component/metric"},next:{title:"MapReduce",permalink:"/go-zero.dev/en/docs/other-component/mapreduce"}},d=[{value:"Background",id:"background",children:[],level:3},{value:"Design purpose",id:"design-purpose",children:[{value:"consumption behavior",id:"consumption-behavior",children:[],level:4},{value:"High Availability",id:"high-availability",children:[],level:4},{value:"Why not use Kafka?",id:"why-not-use-kafka",children:[],level:4}],level:3},{value:"Architecture Design",id:"architecture-design",children:[],level:3},{value:"API Design",id:"api-design",children:[],level:3},{value:"Production Practice",id:"production-practice",children:[{value:"Production side",id:"production-side",children:[],level:4},{value:"consumer side",id:"consumer-side",children:[],level:4},{value:"node",id:"node",children:[],level:4}],level:3},{value:"Usage examples",id:"usage-examples",children:[],level:3}],c={toc:d};function p(e){var t=e.components,s=(0,i.Z)(e,r);return(0,o.kt)("wrapper",(0,a.Z)({},c,s,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"go-queue"},"Go Queue"),(0,o.kt)("p",null,"Delayed queue: a message queue with a delay function"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"deferred \u2192 an indefinite time in the future"),(0,o.kt)("li",{parentName:"ul"},"mq \u2192 consumption behavior is sequential")),(0,o.kt)("p",null,"With this explanation, the whole design is clear. Your purpose is delay, and the bearer container is mq."),(0,o.kt)("h3",{id:"background"},"Background"),(0,o.kt)("p",null,"To list scenarios that may exist in my daily business."),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Creating a delayed schedule and needing to remind the teacher of class"),(0,o.kt)("li",{parentName:"ul"},"Delayed push \u2192 pushing the teacher needs announcements and assignments")),(0,o.kt)("p",null,"To solve the above problem, the easiest and most direct way is to go to the schedule sweeper regularly."),(0,o.kt)("div",{className:"admonition admonition-info alert alert--info"},(0,o.kt)("div",{parentName:"div",className:"admonition-heading"},(0,o.kt)("h5",{parentName:"div"},(0,o.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,o.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,o.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"info")),(0,o.kt)("div",{parentName:"div",className:"admonition-content"},(0,o.kt)("p",{parentName:"div"},"When the service starts, open an asynchronous concurrent process \u2192 scan the msg table at regular intervals, trigger an event when it arrives, and call the corresponding handler"))),(0,o.kt)("p",null,"Several disadvantages."),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Every service that needs a timed/delayed task needs a msg table for additional storage \u2192 storage is coupled with the business"),(0,o.kt)("li",{parentName:"ul"},"Timed scanning \u2192 bad timing control, may miss trigger time"),(0,o.kt)("li",{parentName:"ul"},"It is a burden on the msg table instance. Repeatedly, one service keeps putting constant pressure on the database")),(0,o.kt)("p",null,"What is the biggest problem?"),(0,o.kt)("p",null,"Scheduling model is basically unified, don't do duplicate business logic"),(0,o.kt)("p",null,"We can consider taking the logic out of the specific business logic and turning it into a common part."),(0,o.kt)("p",null,"And this scheduling model, is the delay queue ."),(0,o.kt)("p",null,"In fact, to put it plainly."),(0,o.kt)("p",null,"The delayed queue model is to store future execution events in advance, and then continuously scan this store to execute the corresponding task logic if the execution time is triggered."),(0,o.kt)("p",null,"So is there a ready-made solution in the open source world? The answer is yes. Beanstalk (",(0,o.kt)("a",{parentName:"p",href:"https://github.com/beanstalkd/beanstalkd"},"https://github.com/beanstalkd/beanstalkd"),") basically meets these requirements"),(0,o.kt)("h3",{id:"design-purpose"},"Design purpose"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Consumer behavior at least"),(0,o.kt)("li",{parentName:"ul"},"High availability"),(0,o.kt)("li",{parentName:"ul"},"Real-time"),(0,o.kt)("li",{parentName:"ul"},"Support for message deletion")),(0,o.kt)("p",null,"The design directions for these purposes are stated one at a time."),(0,o.kt)("h4",{id:"consumption-behavior"},"consumption behavior"),(0,o.kt)("p",null,"This concept is taken from mq. mq provides several directions for consuming casts."),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"at most once \u2192 at most once, messages may be lost, but not repeated"),(0,o.kt)("li",{parentName:"ul"},"at least once \u2192 at least once, the message is definitely not lost, but may be repeated"),(0,o.kt)("li",{parentName:"ul"},"exactly once \u2192 once and only once, messages are not lost and not repeated, and are consumed only once.")),(0,o.kt)("p",null,"exactly once is guaranteed on both the producer + consumer side if possible. When the producer has no way to guarantee this, the consumer needs to do a de-duplication before consumption, so that the message is consumed once and not repeatedly, which is guaranteed directly inside the delay queue."),(0,o.kt)("p",null,"The simplest: use redis setNX to achieve unique consumption of job ids"),(0,o.kt)("h4",{id:"high-availability"},"High Availability"),(0,o.kt)("p",null,"Multi-instance deployment is supported. When one instance goes down, there is a backup instance that continues to provide services."),(0,o.kt)("p",null,"This externally available API uses a cluster model, where multiple nodes are encapsulated internally and redundant storage is available across multiple nodes."),(0,o.kt)("h4",{id:"why-not-use-kafka"},"Why not use Kafka?"),(0,o.kt)("p",null,"After considering similar solutions based on message queues such as kafka/rocketmq as storage, the storage design model abandoned this option."),(0,o.kt)("p",null,"For example, suppose we use a message queue storage like Kafka to implement the delay function, each queue time needs to create a separate topic (e.g. Q1-1s, Q1-2s...) . This design is not a big problem in scenarios where the delay time is fixed, but if the delay time varies greatly, the number of topics will be too many, which will turn the disk from sequential reads and writes into random reads and writes, leading to performance degradation and other problems like restart or long recovery time."),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Too many topics \u2192 storage pressure"),(0,o.kt)("li",{parentName:"ul"},"The topic stores the real time, and the reads at different times (topic) are sequential reads \u2192 random reads when scheduling."),(0,o.kt)("li",{parentName:"ul"},"Similarly, when writing, sequential write \u2192 random write")),(0,o.kt)("h3",{id:"architecture-design"},"Architecture Design"),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"dq",src:n(2643).Z})),(0,o.kt)("h3",{id:"api-design"},"API Design"),(0,o.kt)("p",null,"producer"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"producer.At(msg []byte, at time.Time)"),(0,o.kt)("li",{parentName:"ul"},"producer.Delay(body []byte, delay time.Duration)"),(0,o.kt)("li",{parentName:"ul"},"producer.Revoke(ids string)")),(0,o.kt)("p",null,"consumer"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"consumer.Consume(consume handler)")),(0,o.kt)("p",null,"After using the delayed queue, the overall structure of the service is as follows, as well as the state changes of the jobs in the queue."),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"delay queue",src:n(6510).Z})),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"service \u2192 producer.At(msg []byte, at time.Time) \u2192 insert delayed job into the tube"),(0,o.kt)("li",{parentName:"ul"},"Timed trigger \u2192 job state is updated to ready"),(0,o.kt)("li",{parentName:"ul"},"consumer gets ready job \u2192 fetches job and starts consuming; and changes state to reserved"),(0,o.kt)("li",{parentName:"ul"},"Execute the handler logic function passed into the consumer")),(0,o.kt)("h3",{id:"production-practice"},"Production Practice"),(0,o.kt)("p",null,"It mainly describes what specific features we use for delayed queues in our daily development."),(0,o.kt)("h4",{id:"production-side"},"Production side"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"To produce a delayed task in development, just determine the task execution time",(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},"Pass in At() producer.At(msg []byte, at time.Time)"),(0,o.kt)("li",{parentName:"ul"},"The time difference is calculated internally by itself and inserted into tube"))),(0,o.kt)("li",{parentName:"ul"},"If there are changes to the task time, and changes to the task content",(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},"In production time, it may be necessary to create an additional relationship table of logic_id \u2192 job_id"),(0,o.kt)("li",{parentName:"ul"},"Query to job_id \u2192 producer.Revoke(ids string), delete it, and reinsert it")))),(0,o.kt)("h4",{id:"consumer-side"},"consumer side"),(0,o.kt)("p",null,"First, the framework level to ensure that the consumption behavior of exactly once, but the upper business logic consumption failure or network problems, or a variety of problems, resulting in consumption failure, the bottom to the business development to do. Reasons for doing so."),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"framework and the underlying components only to ensure the correctness of the flow of job state"),(0,o.kt)("li",{parentName:"ul"},"Framework consumer side only to ensure the uniformity of consumption behavior"),(0,o.kt)("li",{parentName:"ul"},"delayed tasks in different business behavior is not uniform",(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},"Emphasis on the mandatory nature of the task, the consumption of failure requires continuous retry until the task success"),(0,o.kt)("li",{parentName:"ul"},"Emphasis on the punctuality of the task, then consumption failure, business-insensitive, can choose to discard")))),(0,o.kt)("p",null,"Here is a description of how the consumer side of the framework to ensure the uniformity of consumption behavior."),(0,o.kt)("p",null,"There are cluster and node. cluster."),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"https://github.com/tal-tech/go-queue/blob/master/dq/consumer.go#L45")),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"The cluster internally repackages the consume handler with a layer"),(0,o.kt)("li",{parentName:"ul"},"hash the consume body and use this hash as the key for redis de-duplication"),(0,o.kt)("li",{parentName:"ul"},"If it exists, it is not processed and is discarded")),(0,o.kt)("h4",{id:"node"},"node"),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"https://github.com/tal-tech/go-queue/blob/master/dq/consumernode.go#L36")),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"consume node to get ready job; first execute Reserve(TTR), book this job, will execute this job for logical processing"),(0,o.kt)("li",{parentName:"ul"},"delete(job) in the node; then consume",(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},"If it fails, it will be thrown up to the business layer to do the corresponding under the hood retry")))),(0,o.kt)("p",null,"So for the consumption side, developers need to implement the idempotency of consumption themselves."),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"idempotent",src:n(9850).Z})),(0,o.kt)("h3",{id:"usage-examples"},"Usage examples"),(0,o.kt)("p",null,(0,o.kt)("a",{parentName:"p",href:"https://github.com/zeromicro/go-queue/tree/master/example"},"usage example")))}p.isMDXComponent=!0},6510:function(e,t,n){t.Z=n.p+"assets/images/delay-queue-1c877cf86953a348b998680e772112c8.png"},2643:function(e,t,n){t.Z=n.p+"assets/images/dq-331b7d0b1bbf68ce738abc2b98494908.png"},9850:function(e,t,n){t.Z=n.p+"assets/images/idempotent-31ee2053de9ace0b83517201c6af3c51.png"}}]);